<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 1‡∏ó‡∏î2</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 15px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            margin-bottom: 5px;
            font-size: 1.8em;
        }

        .header .class-info {
            color: #764ba2;
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .header .teacher-info {
            color: #666;
            font-size: 0.95em;
            margin-bottom: 8px;
        }

        .date-time {
            color: #666;
            font-size: 0.9em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        @media (min-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid #667eea;
        }

        .card-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #667eea;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 18px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 2.2em;
            font-weight: bold;
        }

        .mode-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .mode-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .mode-container {
            display: none;
        }

        .mode-container.active {
            display: block;
        }

        .manual-input {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            border: 2px solid #667eea;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .camera-container {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        #video {
            width: 100%;
            display: block;
            border-radius: 12px;
        }

        #canvas {
            display: none;
        }

        .camera-status {
            min-height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.1em;
            padding: 20px;
        }

        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 400px;
            aspect-ratio: 1;
            border: 3px solid #00ff00;
            border-radius: 15px;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
            display: none;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                border-color: #00ff00;
                box-shadow: 0 0 0 9999px rgba(0,0,0,0.5), 0 0 20px #00ff00;
            }
            50% {
                border-color: #00ff00;
                box-shadow: 0 0 0 9999px rgba(0,0,0,0.5), 0 0 40px #00ff00;
            }
        }

        .scan-info {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,255,0,0.9);
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: bold;
            display: none;
            animation: blink 1.5s ease-in-out infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .camera-controls {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #13f1fc 0%, #0470dc 100%);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.9em;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            background: #f0f0f0;
            padding: 5px;
            border-radius: 10px;
        }

        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            color: #666;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .search-box {
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 12px;
            font-size: 1em;
            border: 2px solid #667eea;
            border-radius: 10px;
        }

        .student-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            background: #f8f9fa;
            transition: all 0.3s;
        }

        .student-item.present {
            background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
        }

        .student-item.absent {
            background: #f8f9fa;
        }

        .student-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .student-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            font-weight: bold;
        }

        .student-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 3px;
        }

        .student-id {
            font-size: 0.85em;
            color: #666;
        }

        .check-time {
            font-size: 0.9em;
            color: #00aa00;
            font-weight: bold;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 15px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 1.4em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .modal-body textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 2px solid #667eea;
            border-radius: 10px;
            font-size: 1em;
            font-family: inherit;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: bold;
            z-index: 2000;
            animation: slideIn 0.3s;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
            color: #155724;
        }

        .notification.warning {
            background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);
            color: #856404;
        }

        .notification.error {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: #721c24;
        }

        .loading-spinner {
            display: inline-block;
            width: 15px;
            height: 15px;
            border: 2px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .scan-hint {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            color: #856404;
            font-weight: bold;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
            <div class="class-info">‡∏´‡πâ‡∏≠‡∏á 1/‡∏ó‡∏î2</div>
            <div class="teacher-info">üë®‚Äçüè´ ‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô: [‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π]</div>
            <div class="date-time" id="dateTime">‚Äî</div>
        </div>

        <div class="main-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                        <div class="stat-value" id="presentCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                        <div class="stat-value" id="absentCount">30</div>
                    </div>
                </div>

                <div class="mode-toggle">
                    <button class="mode-btn" onclick="switchMode('manual')">‚å®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™</button>
                    <button class="mode-btn active" onclick="switchMode('camera')">üì∑ ‡πÅ‡∏™‡∏Å‡∏ô</button>
                </div>

                <div id="manualMode" class="mode-container">
                    <input type="text" id="manualInput" class="manual-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter" autofocus>
                </div>

                <div id="cameraMode" class="mode-container active">
                    <div id="scanHint" class="scan-hint">
                        üí° ‡∏ß‡∏≤‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏Å‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                    </div>
                    <div class="camera-container">
                        <video id="video" autoplay playsinline></video>
                        <canvas id="canvas"></canvas>
                        <div class="camera-status" id="cameraStatus">
                            <div style="font-size: 2.5em;">üì∑</div>
                            <div>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</div>
                        </div>
                        <div class="scanner-overlay" id="scannerOverlay"></div>
                        <div class="scan-info" id="scanInfo">üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏Å‡∏ô...</div>
                    </div>
                    <div class="camera-controls">
                        <button id="startCamera" class="btn btn-primary">üì∑ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                        <button id="stopCamera" class="btn btn-danger" disabled>‚èπÔ∏è ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">üë• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                </div>

                <div class="tabs">
                    <div class="tab active" data-tab="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (30)</div>
                    <div class="tab" data-tab="present">‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (0)</div>
                    <div class="tab" data-tab="absent">‡∏Ç‡∏≤‡∏î (30)</div>
                </div>

                <div class="search-box">
                    <input type="text" id="searchInput" class="search-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™...">
                </div>

                <div class="student-list" id="studentList"></div>

                <div class="action-buttons">
                    <button class="btn btn-success" onclick="exportToExcel()">üìä Excel</button>
                    <button class="btn btn-warning" onclick="showHistory()">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
                    <button class="btn btn-danger" onclick="resetAttendance()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header"><h3>‚ö†Ô∏è ‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</h3></div>
            <div class="modal-body">
                <p id="editStudentInfo" style="margin-bottom:15px;font-weight:bold;color:#667eea;"></p>
                <div style="background:#fff3cd;border:2px solid #ffc107;border-radius:8px;padding:12px;margin-bottom:15px;font-size:0.9em;">
                    <strong>üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏Å‡∏á
                </div>
                <label style="font-weight:bold;margin-bottom:8px;display:block;">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö):</label>
                <textarea id="editReason" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡∏´‡∏ô‡∏µ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á, ‡∏°‡∏≤‡∏™‡∏≤‡∏¢ 30 ‡∏ô‡∏≤‡∏ó‡∏µ, ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏≤‡∏ö..." style="min-height:120px;"></textarea>
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:15px;">
                <button class="btn btn-primary btn-small" onclick="closeEditModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="btn btn-danger btn-small" onclick="confirmEdit()">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            </div>
        </div>
    </div>

    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header"><h3>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</h3></div>
            <div id="historyContent" style="max-height:400px;overflow-y:auto;"></div>
            <div style="display:flex;justify-content:flex-end;margin-top:15px;">
                <button class="btn btn-primary btn-small" onclick="closeHistoryModal()">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <script>
const students=[{"id":"68219100031","barcode":"68219100031","name":"‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ä‡∏ô‡∏Å‡∏ô‡∏±‡∏ô‡∏ó‡πå ‡∏Ç‡∏±‡∏ô‡∏ô‡∏≤‡∏Ñ","class":"1‡∏ó‡∏î2"},{"id":"68219100032","barcode":"68219100032","name":"‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ä‡∏≤‡∏•‡∏¥‡∏™‡∏≤ ‡πÅ‡∏Å‡πâ‡∏ß‡∏°‡∏ì‡∏µ","class":"1‡∏ó‡∏î2"},{"id":"68219100033","barcode":"68219100033","name":"‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ê‡∏ô‡∏±‡∏î‡∏î‡∏≤ ‡∏û‡∏∏‡πà‡∏°‡∏™‡∏∏‡∏Ç","class":"1‡∏ó‡∏î2"},{"id":"68219100034","barcode":"68219100034","name":"‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ò‡∏±‡∏ç‡∏ç‡∏≤‡∏£‡∏±‡∏ï‡∏ô‡πå ‡∏™‡πà‡∏≤‡∏´‡∏£‡πà‡∏≤‡∏¢‡∏£‡∏±‡∏Å‡∏©‡πå","class":"1‡∏ó‡∏î2"},{"id":"68219100035","barcode":"68219100035","name":"‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ò‡∏±‡∏ç‡∏£‡∏±‡∏ï‡∏ô‡πå ‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏Ç‡∏≤‡∏ß","class":"1‡∏ó‡∏î2"},{"id":"68219100036","barcode":"68219100036","name":"‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ô‡∏±‡∏ô‡∏ó‡πå‡∏ô‡∏†‡∏±‡∏™ ‡∏î‡∏ß‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î","class":"1‡∏ó‡∏î2"},{"id":"68219100037","barcode":"68219100037","name":"‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏†‡∏±‡∏™‡∏™‡∏£ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏°‡∏π‡∏•","class":"1‡∏ó‡∏î2"},{"id":"68219100038","barcode":"68219100038","name":"‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏û‡∏£‡∏û‡∏£‡∏£‡∏ì ‡∏†‡∏π‡πà‡∏£‡∏∞‡∏´‡∏á‡∏©‡πå","class":"1‡∏ó‡∏î2"},{"id":"68219100039","barcode":"68219100039","name":"‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏†‡∏±‡∏ó‡∏£‡∏ß‡∏•‡∏±‡∏¢ ‡∏ß‡∏¥‡πÄ‡∏®‡∏©‡πÄ‡∏à‡∏£‡∏¥‡∏ç","class":"1‡∏ó‡∏î2"},{"id":"68219100040","barcode":"68219100040","name":"‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏•‡∏•‡∏¥‡∏ï‡∏≤ ‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡∏•‡∏µ‡∏¨‡∏´‡∏≤","class":"1‡∏ó‡∏î2"},{"id":"68219100041","barcode":"68219100041","name":"‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ß‡∏£‡∏¢‡∏≤ ‡∏†‡∏±‡∏ó‡∏£‡∏≤‡∏£‡∏ß‡∏µ‡∏¢‡πå","class":"1‡∏ó‡∏î2"},{"id":"68219100042","barcode":"68219100042","name":"‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ß‡∏£‡∏¥‡∏™‡∏£‡∏≤ ‡πÅ‡∏™‡∏á‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì","class":"1‡∏ó‡∏î2"},{"id":"68219100043","barcode":"68219100043","name":"‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ß‡∏£‡∏¥‡∏®‡∏£‡∏≤ ‡πÄ‡∏¢‡∏™‡∏π‡∏á‡πÄ‡∏ô‡∏¥‡∏ô","class":"1‡∏ó‡∏î2"},{"id":"68219100044","barcode":"68219100044","name":"‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ß‡∏µ‡∏£‡∏≤‡∏†‡∏±‡∏ó‡∏£ ‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡∏®","class":"1‡∏ó‡∏î2"},{"id":"68219100045","barcode":"68219100045","name":"‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏®‡∏®‡∏¥‡∏Å‡∏°‡∏• ‡πÅ‡∏Å‡πâ‡∏ß‡∏™‡∏°‡∏ô‡∏∂‡∏Å","class":"1‡∏ó‡∏î2"},{"id":"68219100046","barcode":"68219100046","name":"‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏®‡∏®‡∏¥‡∏ß‡∏¥‡∏°‡∏• ‡∏á‡∏≤‡∏á‡∏≤‡∏°","class":"1‡∏ó‡∏î2"},{"id":"68219100047","barcode":"68219100047","name":"‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏±‡∏ï‡∏ô‡πå ‡∏û‡∏£‡∏û‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡∏®","class":"1‡∏ó‡∏î2"},{"id":"68219100048","barcode":"68219100048","name":"‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏≠‡∏£‡∏ô‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå ‡∏Ñ‡∏π‡πà‡πÅ‡∏à‡∏Å‡∏±‡∏ô","class":"1‡∏ó‡∏î2"},{"id":"68219100049","barcode":"68219100049","name":"‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏≠‡∏±‡∏ç‡∏ä‡∏•‡∏µ‡∏û‡∏£ ‡∏û‡∏∏‡∏ó‡∏ò‡∏≤‡∏™‡∏∏‡πà‡∏ô","class":"1‡∏ó‡∏î2"},{"id":"68219100050","barcode":"68219100050","name":"‡∏ô‡∏≤‡∏¢‡∏Å‡∏¥‡∏ï‡∏ï‡∏¥‡∏û‡∏¥‡∏ä‡∏ç‡πå ‡∏ê‡∏¥‡∏ï‡∏ï‡∏¥‡∏û‡∏∏‡∏í‡∏¥‡∏ô‡∏±‡∏ô‡∏ó‡πå","class":"1‡∏ó‡∏î2"},{"id":"68219100051","barcode":"68219100051","name":"‡∏ô‡∏≤‡∏¢‡∏ñ‡∏¥‡∏£‡∏ß‡∏¥‡∏ó‡∏¢‡πå ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏Ç‡∏≥","class":"1‡∏ó‡∏î2"},{"id":"68219100052","barcode":"68219100052","name":"‡∏ô‡∏≤‡∏¢‡∏ò‡∏ô‡∏±‡∏ó ‡∏ó‡∏≤‡∏£‡∏∞‡∏ê‡∏¥‡∏ô","class":"1‡∏ó‡∏î2"},{"id":"68219100053","barcode":"68219100053","name":"‡∏ô‡∏≤‡∏¢‡∏ò‡∏µ‡∏£‡πÄ‡∏ó‡∏û ‡∏Å‡∏•‡∏±‡πà‡∏ô‡∏™‡∏Å‡∏∏‡∏•","class":"1‡∏ó‡∏î2"},{"id":"68219100054","barcode":"68219100054","name":"‡∏ô‡∏≤‡∏¢‡∏ô‡∏û‡∏û‡∏£ ‡∏ï‡∏°‡∏∞‡∏ß‡∏¥‡πÇ‡∏°‡∏Å‡∏©‡πå","class":"1‡∏ó‡∏î2"},{"id":"68219100055","barcode":"68219100055","name":"‡∏ô‡∏≤‡∏¢‡∏†‡∏µ‡∏£‡πå‡∏†‡∏±‡∏ó‡∏£ ‡∏ó‡∏¥‡∏û‡∏¢‡πå‡πÄ‡∏ô‡∏ï‡∏£","class":"1‡∏ó‡∏î2"},{"id":"68219100056","barcode":"68219100056","name":"‡∏ô‡∏≤‡∏¢‡∏£‡∏±‡∏ê‡∏ò‡∏µ‡∏£‡πå ‡∏ß‡∏±‡∏î‡πÇ‡∏•‡∏Å","class":"1‡∏ó‡∏î2"},{"id":"68219100057","barcode":"68219100057","name":"‡∏ô‡∏≤‡∏¢‡∏£‡∏±‡∏ê‡∏†‡∏π‡∏°‡∏¥ ‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå","class":"1‡∏ó‡∏î2"},{"id":"68219100058","barcode":"68219100058","name":"‡∏ô‡∏≤‡∏¢‡∏≠‡∏°‡∏£‡πÄ‡∏ó‡∏û -","class":"1‡∏ó‡∏î2"},{"id":"68219100059","barcode":"68219100059","name":"‡∏ô‡∏≤‡∏¢‡∏≠‡∏°‡∏£‡πÄ‡∏ó‡∏û ‡πÄ‡∏ä‡πâ‡∏≤‡∏ß‡∏£‡∏£‡∏ì‡πÇ‡∏ì","class":"1‡∏ó‡∏î2"},{"id":"68219100060","barcode":"68219100060","name":"‡∏ô‡∏≤‡∏¢‡∏≠‡∏≤‡∏ô‡∏ô‡∏ó‡πå ‡πÅ‡∏ã‡πà‡∏•‡∏µ‡πâ (‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á)","class":"1‡∏ó‡∏î2"}];

let attendance = {};
let editHistory = [];
let currentTab = 'all';
let searchQuery = '';
let currentEditStudent = null;
let isScanning = false;
let lastScannedCode = '';
let lastScannedTime = 0;
let video, canvas, ctx;
let codeReader = null;
let scanInterval = null;

// ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å requestAnimationFrame ‡πÄ‡∏õ‡πá‡∏ô setInterval ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏Ñ‡∏á‡∏ó‡∏µ‡πà
// ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£ scan ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
const SCAN_INTERVAL_MS = 150; // ‡∏™‡πÅ‡∏Å‡∏ô‡∏ó‡∏∏‡∏Å 150ms (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 6-7 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
const DUPLICATE_THRESHOLD_MS = 3000; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡∏ã‡πâ‡∏≥‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

function switchMode(m) {
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    document.querySelectorAll('.mode-container').forEach(c => c.classList.remove('active'));
    
    if (m === 'manual') {
        document.getElementById('manualMode').classList.add('active');
        setTimeout(() => document.getElementById('manualInput').focus(), 100);
        if (isScanning) stopCamera();
    } else {
        document.getElementById('cameraMode').classList.add('active');
        document.getElementById('scanHint').style.display = 'block';
    }
}

document.getElementById('manualInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        const code = this.value.trim();
        if (code) {
            processBarcode(code);
            this.value = '';
        }
    }
});

function updateDateTime() {
    document.getElementById('dateTime').textContent = new Date().toLocaleString('th-TH', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
}

function showNotification(msg, type = 'success') {
    const existing = document.querySelector('.notification');
    if (existing) existing.remove();
    
    const notif = document.createElement('div');
    notif.className = `notification ${type}`;
    notif.textContent = msg;
    document.body.appendChild(notif);
    
    setTimeout(() => {
        notif.style.animation = 'slideIn 0.3s reverse';
        setTimeout(() => notif.remove(), 300);
    }, 3000);
}

document.getElementById('startCamera').addEventListener('click', async function() {
    const btn = this;
    video = document.getElementById('video');
    canvas = document.getElementById('canvas');
    ctx = canvas.getContext('2d', { willReadFrequently: true });
    const status = document.getElementById('cameraStatus');
    const overlay = document.getElementById('scannerOverlay');
    const info = document.getElementById('scanInfo');
    
    try {
        btn.disabled = true;
        btn.innerHTML = '<span class="loading-spinner"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î...';
        status.innerHTML = '<div style="font-size:2em;">‚è≥</div><div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á...</div>';
        
        // ‡∏•‡∏≠‡∏á‡∏´‡∏•‡∏≤‡∏¢ constraints ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö
        let stream = null;
        const constraints = [
            // ‡∏•‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô
            { video: true },
            // ‡∏•‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á
            { video: { facingMode: 'environment' } },
            // ‡∏•‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
            { video: { facingMode: 'environment', width: 1280, height: 720 } }
        ];
        
        for (let i = 0; i < constraints.length; i++) {
            try {
                stream = await navigator.mediaDevices.getUserMedia(constraints[i]);
                if (stream) break;
            } catch (e) {
                console.log(`Constraint ${i} failed:`, e);
                if (i === constraints.length - 1) throw e;
            }
        }
        
        if (!stream) {
            throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ');
        }
        
        video.srcObject = stream;
        video.setAttribute('playsinline', true);
        video.setAttribute('autoplay', true);
        
        // ‡∏£‡∏≠‡πÉ‡∏´‡πâ video ‡∏û‡∏£‡πâ‡∏≠‡∏°
        await new Promise((resolve, reject) => {
            video.onloadedmetadata = () => {
                video.play()
                    .then(() => {
                        // ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ video ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß
                        setTimeout(() => {
                            if (video.readyState >= 2) {
                                resolve();
                            } else {
                                reject(new Error('Video not ready'));
                            }
                        }, 500);
                    })
                    .catch(reject);
            };
            video.onerror = reject;
            
            // Timeout
            setTimeout(() => reject(new Error('Timeout')), 10000);
        });
        
        canvas.width = video.videoWidth || 1280;
        canvas.height = video.videoHeight || 720;
        
        status.style.display = 'none';
        overlay.style.display = 'block';
        info.style.display = 'block';
        isScanning = true;
        
        btn.innerHTML = 'üì∑ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á';
        btn.disabled = false;
        document.getElementById('stopCamera').disabled = false;
        
        showNotification('‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        
        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô
        startScanning();
        
    } catch (err) {
        console.error('Camera error:', err);
        
        let errorMsg = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
        if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
            errorMsg = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á';
        } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
            errorMsg = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á';
        } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
            errorMsg = '‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà';
        } else if (err.message) {
            errorMsg = err.message;
        }
        
        status.innerHTML = `
            <div style="font-size:2em;color:#fa709a;">‚ùå</div>
            <div>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ</div>
            <div style="font-size:0.85em;margin-top:8px;color:#ccc;">${errorMsg}</div>
            <div style="font-size:0.75em;margin-top:8px;color:#999;">‡∏•‡∏≠‡∏á‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</div>
        `;
        btn.disabled = false;
        btn.innerHTML = 'üì∑ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á';
        showNotification(`‚ùå ${errorMsg}`, 'error');
    }
});

// ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô
function startScanning() {
    if (scanInterval) {
        clearInterval(scanInterval);
    }
    
    scanInterval = setInterval(() => {
        if (!isScanning || video.readyState !== video.HAVE_ENOUGH_DATA) {
            return;
        }
        
        try {
            // ‡∏ß‡∏≤‡∏î‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å video ‡∏•‡∏á‡πÉ‡∏ô canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            // ‡∏•‡∏≠‡∏á jsQR ‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤)
            const qrCode = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert"
            });
            
            if (qrCode && qrCode.data) {
                processBarcode(qrCode.data);
                return;
            }
            
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ QR ‡∏•‡∏≠‡∏á ZXing ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î
            scanWithZXing();
            
        } catch (err) {
            console.error('Scan error:', err);
        }
    }, SCAN_INTERVAL_MS);
}

// ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á: ZXing scanner ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô
function scanWithZXing() {
    if (!codeReader) {
        codeReader = new ZXing.BrowserMultiFormatReader();
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ hints ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô
        const hints = new Map();
        hints.set(ZXing.DecodeHintType.TRY_HARDER, false); // ‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô
        hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
            ZXing.BarcodeFormat.CODE_128,
            ZXing.BarcodeFormat.CODE_39,
            ZXing.BarcodeFormat.EAN_13,
            ZXing.BarcodeFormat.EAN_8,
            ZXing.BarcodeFormat.UPC_A,
            ZXing.BarcodeFormat.ITF
        ]);
        codeReader.hints = hints;
    }
    
    try {
        const result = codeReader.decodeFromCanvas(canvas);
        if (result && result.text) {
            processBarcode(result.text);
        }
    } catch (err) {
        // ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£
    }
}

function stopCamera() {
    isScanning = false;
    
    // ‡∏´‡∏¢‡∏∏‡∏î interval
    if (scanInterval) {
        clearInterval(scanInterval);
        scanInterval = null;
    }
    
    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï code reader
    if (codeReader) {
        try {
            codeReader.reset();
        } catch (err) {
            console.error('Reset error:', err);
        }
    }
    
    // ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
    if (video && video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
        video.srcObject = null;
    }
    
    document.getElementById('cameraStatus').style.display = 'flex';
    document.getElementById('cameraStatus').innerHTML = '<div style="font-size:2.5em;">üì∑</div><div>‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß</div>';
    document.getElementById('scannerOverlay').style.display = 'none';
    document.getElementById('scanInfo').style.display = 'none';
    document.getElementById('startCamera').disabled = false;
    document.getElementById('stopCamera').disabled = true;
}

document.getElementById('stopCamera').addEventListener('click', () => {
    stopCamera();
    showNotification('‚èπÔ∏è ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß', 'warning');
});

// ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤
function processBarcode(barcode) {
    if (!barcode || typeof barcode !== 'string') return;
    
    barcode = barcode.trim();
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const now = Date.now();
    if (barcode === lastScannedCode && (now - lastScannedTime) < DUPLICATE_THRESHOLD_MS) {
        return; // ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡∏ã‡πâ‡∏≥
    }
    
    lastScannedCode = barcode;
    lastScannedTime = now;
    
    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
    const student = students.find(s => s.barcode === barcode || s.id === barcode);
    
    if (student) {
        if (attendance[student.id]) {
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥
            showNotification(`‚ö†Ô∏è ${student.name} ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß!`, 'warning');
            if ('vibrate' in navigator) navigator.vibrate([100, 50, 100]);
        } else {
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            attendance[student.id] = {
                time: new Date().toLocaleTimeString('th-TH'),
                date: new Date().toLocaleDateString('th-TH'),
                edited: false
            };
            
            showNotification(`‚úÖ ${student.name} ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`, 'success');
            if ('vibrate' in navigator) navigator.vibrate(200);
            
            updateDisplay();
        }
    } else {
        // ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        showNotification(`‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (${barcode})`, 'error');
        if ('vibrate' in navigator) navigator.vibrate([100, 50, 100, 50, 100]);
    }
}

function updateDisplay() {
    updateStats();
    updateStudentList();
    updateTabCounts();
}

function updateStats() {
    const presentCount = Object.keys(attendance).length;
    document.getElementById('presentCount').textContent = presentCount;
    document.getElementById('absentCount').textContent = students.length - presentCount;
}

function updateTabCounts() {
    const presentCount = Object.keys(attendance).length;
    document.querySelectorAll('.tab').forEach(tab => {
        const tabType = tab.dataset.tab;
        if (tabType === 'all') {
            tab.textContent = `‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (${students.length})`;
        } else if (tabType === 'present') {
            tab.textContent = `‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (${presentCount})`;
        } else if (tabType === 'absent') {
            tab.textContent = `‡∏Ç‡∏≤‡∏î (${students.length - presentCount})`;
        }
    });
}

function updateStudentList() {
    let filtered = students;
    
    // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° tab
    if (currentTab === 'present') {
        filtered = students.filter(s => attendance[s.id]);
    } else if (currentTab === 'absent') {
        filtered = students.filter(s => !attendance[s.id]);
    }
    
    // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    if (searchQuery) {
        filtered = filtered.filter(s => 
            s.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
            s.id.includes(searchQuery)
        );
    }
    
    const list = document.getElementById('studentList');
    
    if (filtered.length === 0) {
        list.innerHTML = '<div style="text-align:center;padding:40px;color:#999;"><div style="font-size:3em;">üîç</div><div>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div></div>';
        return;
    }
    
    list.innerHTML = filtered.map(student => {
        const att = attendance[student.id];
        const initial = student.name.charAt(3);
        
        return `
            <div class="student-item ${att ? 'present' : 'absent'}">
                <div class="student-info">
                    <div class="student-avatar">${initial}</div>
                    <div>
                        <div class="student-name">${student.name}</div>
                        <div class="student-id">‡∏£‡∏´‡∏±‡∏™: ${student.id}</div>
                        ${att && att.edited ? '<div style="font-size:0.75em;color:#ff6b6b;font-weight:bold;margin-top:2px;">‚ö†Ô∏è ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</div>' : ''}
                    </div>
                </div>
                <div style="display:flex;flex-direction:column;align-items:flex-end;gap:5px;">
                    <div class="check-time">${att ? `‚úì ${att.time}` : '‚Äî'}</div>
                    ${att ? `<button class="btn btn-danger btn-small" onclick="openEditModal('${student.id}')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>` : ''}
                </div>
            </div>
        `;
    }).join('');
}

// Tab switching
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', function() {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        currentTab = this.dataset.tab;
        updateStudentList();
    });
});

// Search
document.getElementById('searchInput').addEventListener('input', function(e) {
    searchQuery = e.target.value;
    updateStudentList();
});

// Edit modal
function openEditModal(studentId) {
    currentEditStudent = studentId;
    const student = students.find(s => s.id === studentId);
    document.getElementById('editStudentInfo').textContent = `${student.name} (${student.id})`;
    document.getElementById('editReason').value = '';
    document.getElementById('editModal').classList.add('active');
}

function closeEditModal() {
    document.getElementById('editModal').classList.remove('active');
}

function confirmEdit() {
    const reason = document.getElementById('editReason').value.trim();
    
    if (!reason) {
        showNotification('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•', 'warning');
        return;
    }
    
    const student = students.find(s => s.id === currentEditStudent);
    const oldData = { ...attendance[currentEditStudent] };
    
    // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏Å‡∏á)
    attendance[currentEditStudent].edited = true;
    attendance[currentEditStudent].editReason = reason;
    attendance[currentEditStudent].editTime = new Date().toLocaleString('th-TH');
    
    editHistory.push({
        studentId: currentEditStudent,
        studentName: student.name,
        action: '‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç',
        reason: reason,
        oldTime: oldData.time,
        timestamp: new Date().toLocaleString('th-TH'),
        editor: '‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô'
    });
    
    showNotification(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ${student.name} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
    updateDisplay();
    closeEditModal();
}

// History modal
function showHistory() {
    const content = document.getElementById('historyContent');
    
    if (editHistory.length === 0) {
        content.innerHTML = '<div style="text-align:center;padding:40px;color:#999;"><div style="font-size:3em;">üìú</div><div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div></div>';
    } else {
        content.innerHTML = editHistory.map((h, i) => `
            <div style="padding:10px;margin-bottom:8px;background:#f8f9fa;border-radius:8px;font-size:0.85em;">
                <div style="font-weight:bold;color:#667eea;margin-bottom:5px;">#${editHistory.length - i} ${h.studentName}</div>
                <div><strong>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£:</strong> ${h.action}</div>
                <div><strong>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏°:</strong> ${h.oldTime}</div>
                <div><strong>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</strong> ${h.reason}</div>
                <div style="color:#666;font-size:0.8em;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏î‡∏¢ ${h.editor} ‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${h.timestamp}</div>
            </div>
        `).reverse().join('');
    }
    
    document.getElementById('historyModal').classList.add('active');
}

function closeHistoryModal() {
    document.getElementById('historyModal').classList.remove('active');
}

// Export to Excel
function exportToExcel() {
    const data = students.map((student, index) => {
        const att = attendance[student.id];
        return {
            '‡∏•‡∏≥‡∏î‡∏±‡∏ö': index + 1,
            '‡∏£‡∏´‡∏±‡∏™': student.id,
            '‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•': student.name,
            '‡∏´‡πâ‡∏≠‡∏á': student.class,
            '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞': att ? '‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' : '‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
            '‡πÄ‡∏ß‡∏•‡∏≤': att ? att.time : '-',
            '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': att ? att.date : '-',
            '‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç': att && att.edited ? '‡πÉ‡∏ä‡πà' : '‡πÑ‡∏°‡πà',
            '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç': att && att.edited ? att.editReason : '-'
        };
    });
    
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, '‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô');
    
    if (editHistory.length > 0) {
        const historyData = editHistory.map((h, i) => ({
            '‡∏•‡∏≥‡∏î‡∏±‡∏ö': i + 1,
            '‡∏£‡∏´‡∏±‡∏™': h.studentId,
            '‡∏ä‡∏∑‡πà‡∏≠': h.studentName,
            '‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£': h.action,
            '‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏°': h.oldTime,
            '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•': h.reason,
            '‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç': h.timestamp,
            '‡∏ú‡∏π‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç': h.editor
        }));
        const wh = XLSX.utils.json_to_sheet(historyData);
        XLSX.utils.book_append_sheet(wb, wh, '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç');
    }
    
    const dateStr = new Date().toLocaleDateString('th-TH').replace(/\//g, '-');
    XLSX.writeFile(wb, `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô_1‡∏ó‡∏î2_${dateStr}.xlsx`);
    showNotification('üìä ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
}

// Reset
function resetAttendance() {
    if (confirm('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) {
        attendance = {};
        editHistory = [];
        updateDisplay();
        showNotification('üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.classList.remove('active');
    }
}

// Initialize
updateDateTime();
setInterval(updateDateTime, 1000);
updateDisplay();

setTimeout(() => {
    const input = document.getElementById('manualInput');
    if (input) input.focus();
}, 500);

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (isScanning) stopCamera();
});
    </script>
</body>
</html>